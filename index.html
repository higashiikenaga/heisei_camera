<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>å¹³æˆã‚«ãƒ¡ãƒ©</title>

<!-- ãƒ•ã‚©ãƒ³ãƒˆï¼ˆæ¶²æ™¶ãƒ»VHSé¢¨ï¼‰ -->
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Press+Start+2P&display=swap" rel="stylesheet">

<style>
body{margin:0;padding:1rem;background:#111;color:#eee;
font-family:'Orbitron',monospace;text-align:center;letter-spacing:0.5px;}
h2{margin-bottom:.5rem;font-family:'Orbitron',monospace;font-size:1.4rem;color:#8ff;text-shadow:0 0 8px #0ff;}
#stage{position:relative;width:min(90vw,480px);aspect-ratio:4/3;margin:auto;background:#000;border:2px solid #333;overflow:hidden;}
canvas{width:100%;height:100%;image-rendering:pixelated;image-rendering:crisp-edges;}
#hud{position:absolute;inset:0;pointer-events:none;font-family:'Press Start 2P',monospace;
font-size:10px;line-height:1.3;color:#f66;text-shadow:0 0 4px #000;}
.rec{position:absolute;top:10px;left:10px;display:flex;align-items:center;gap:6px;}
.dot{width:10px;height:10px;border-radius:50%;background:red;box-shadow:0 0 6px #f00;}
.date{position:absolute;bottom:10px;right:10px;color:#ffa64d;text-shadow:0 1px 2px #000;}
.timecode{position:absolute;bottom:10px;left:10px;color:#f44;font-size:12px;text-shadow:0 0 4px #000;}
button,select,input{margin:5px;padding:8px;border:none;border-radius:8px;background:#1d1d1d;color:#eee;font-weight:600;font-family:'Orbitron',monospace;}
#download{display:none;margin-top:10px;}
label{font-size:0.9em;}
</style>
</head>

<body>
<h2>ğŸ“· å¹³æˆã‚«ãƒ¡ãƒ©</h2>
<div id="stage">
  <canvas id="canvas" width="640" height="480"></canvas>
  <div id="hud">
    <div class="rec"><div class="dot" id="dot"></div><span>REC</span></div>
    <div class="date" id="date"></div>
    <div class="timecode" id="timecode">00:00:00</div>
  </div>
</div>

<div>
<select id="mode">
  <option value="dslr">ğŸ“· ä¸€çœ¼é¢¨</option>
  <option value="compact">ğŸ“¸ ã‚³ãƒ³ãƒ‡ã‚¸é¢¨</option>
  <option value="8mm">ğŸ 8ãƒŸãƒªé¢¨</option>
  <option value="vhs">ğŸ“º VHSé¢¨</option>
</select>
<label>ãƒ†ãƒ¼ãƒ—ãƒã‚¤ã‚º:<input type="range" id="tape" min="0" max="100" value="15"></label>
<label>ğŸ™éŸ³å£°<input type="checkbox" id="mic" checked></label><br>
<button id="photoBtn">ğŸ“¸ å†™çœŸ</button>
<button id="recStart">ğŸ¥ éŒ²ç”»</button>
<button id="recStop" disabled>â¹ åœæ­¢</button>
<a id="download" download="heisei_camera.webm">ğŸ¬ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</a>
</div>

<!-- ğŸ”‡ éŸ³ã¯å‡ºã•ãªã„ãŒã€éŒ²éŸ³ã¯ã™ã‚‹ -->
<video id="video" autoplay playsinline muted style="display:none;"></video>

<script>
(async()=>{
const video=document.getElementById("video");
const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d",{willReadFrequently:true});
const low=document.createElement("canvas");low.width=320;low.height=240;
const lctx=low.getContext("2d",{willReadFrequently:true});
let recorder,blobs=[],stream=null,mode="dslr",recTime=0;

// ====== ã‚«ãƒ¡ãƒ©èµ·å‹•ï¼ˆéŒ²éŸ³ã¯ã™ã‚‹ãŒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç„¡éŸ³ï¼‰ ======
async function startCamera(){
  if(stream){stream.getTracks().forEach(t=>t.stop());}
  const withAudio=document.getElementById("mic").checked;
  try{
    stream=await navigator.mediaDevices.getUserMedia({
      video:{facingMode:"environment"},
      audio:withAudio ? {echoCancellation:true,noiseSuppression:true} : false
    });
    video.srcObject=stream;
    video.muted=true; // ğŸ”‡ å†ç”Ÿã¯å¸¸ã«ãƒŸãƒ¥ãƒ¼ãƒˆ
    await video.play();
  }catch(e){alert("ã‚«ãƒ¡ãƒ©ãƒ»ãƒã‚¤ã‚¯èµ·å‹•å¤±æ•—ï¼š"+e);}
}
await startCamera();
document.getElementById("mic").onchange=startCamera;
document.getElementById("mode").onchange=e=>mode=e.target.value;

// ====== HUDæ›´æ–° ======
function updateHUD(){
  const n=new Date();
  document.getElementById("date").textContent=
    `${String(n.getFullYear()).slice(-2)}.${String(n.getMonth()+1).padStart(2,'0')}.${String(n.getDate()).padStart(2,'0')}  ${String(n.getHours()).padStart(2,'0')}:${String(n.getMinutes()).padStart(2,'0')}`;
  if(recTime>0){
    const sec=Math.floor((Date.now()-recTime)/1000);
    const h=String(sec/3600|0).padStart(2,'0');
    const m=String((sec%3600)/60|0).padStart(2,'0');
    const s=String(sec%60).padStart(2,'0');
    document.getElementById("timecode").textContent=`${h}:${m}:${s}`;
  }else document.getElementById("timecode").textContent="00:00:00";
}

// ====== åŠ£åŒ–å‡¦ç†ï¼ˆç°¡ç•¥ï¼‰ ======
function process(img){
  const d=img.data,w=img.width,h=img.height;
  for(let i=0;i<d.length;i+=4){
    let r=d[i],g=d[i+1],b=d[i+2];
    const avg=(r+g+b)/3;
    if(mode==="vhs"){const n=(Math.random()-.5)*50;r+=n;g+=n;b+=n;if(((i/(4*w))|0)%2===0){b*=0.9;g*=1.1;}}
    else if(mode==="8mm"){const n=(Math.random()-.5)*25;r=r*0.93+avg*0.07+n;g=g*0.89+avg*0.11+n*0.6;b=b*0.85+avg*0.15+n*1.0;}
    else if(mode==="compact"){const n=(Math.random()-.5)*10;r=r*1.15+n;g=g*1.08+n;b=b*1.08+n;}
    else{r*=1.08;g*=1.08;b*=1.1;}
    d[i]=r;d[i+1]=g;d[i+2]=b;
  }
  return img;
}

// ====== æç”»ãƒ«ãƒ¼ãƒ— ======
function render(){
  if(video.readyState>=2){
    const vw=video.videoWidth,vh=video.videoHeight;
    const ar=vw/vh,tar=4/3;let sx=0,sy=0,sw=vw,sh=vh;
    if(ar>tar){sw=vh*tar;sx=(vw-sw)/2;}else{sh=vw/tar;sy=(vh-sh)/2;}
    lctx.drawImage(video,sx,sy,sw,sh,0,0,low.width,low.height);
    let img=lctx.getImageData(0,0,low.width,low.height);
    lctx.putImageData(process(img),0,0);
    ctx.imageSmoothingEnabled=false;
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.drawImage(low,0,0,canvas.width,canvas.height);
  }
  updateHUD();
  document.getElementById("dot").style.opacity=(Date.now()/500%2>1)?1:0.3;
  requestAnimationFrame(render);
}
render();

// ====== å†™çœŸæ’®å½± ======
document.getElementById("photoBtn").onclick=()=>{
  canvas.toBlob(blob=>{
    const a=document.createElement("a");
    a.href=URL.createObjectURL(blob);
    a.download=`heisei_${mode}_${Date.now()}.jpg`;
    a.click();URL.revokeObjectURL(a.href);
  },"image/jpeg",0.9);
};

// ====== éŒ²ç”»ï¼ˆğŸ§éŒ²éŸ³ã¯ã™ã‚‹ãŒğŸ”‡å†ç”Ÿã—ãªã„ï¼‰ ======
document.getElementById("recStart").onclick=async ()=>{
  blobs=[];recTime=Date.now();
  const fps=(mode==="8mm"?12:(mode==="vhs"?15:24));
  const canvasStream=canvas.captureStream(fps);
  const audioTrack=stream.getAudioTracks()[0];
  if(audioTrack) canvasStream.addTrack(audioTrack); // ğŸ™ éŒ²éŸ³ã®ã¿è¿½åŠ 

  recorder=new MediaRecorder(canvasStream,{mimeType:"video/webm;codecs=vp8,opus"});
  recorder.ondataavailable=e=>{if(e.data.size>0)blobs.push(e.data);};
  recorder.onstop=()=>{
    recTime=0;
    const blob=new Blob(blobs,{type:"video/webm"});
    const url=URL.createObjectURL(blob);
    const a=document.getElementById("download");
    a.href=url;a.style.display="inline";
    a.textContent=`ğŸ¬ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ (${(blob.size/1024/1024).toFixed(1)}MB)`;
  };
  recorder.start(100);
  recStart.disabled=true;
  recStop.disabled=false;
};
document.getElementById("recStop").onclick=()=>{
  recorder.stop();
  recStart.disabled=false;
  recStop.disabled=true;
};
})();
</script>
</body>
</html>

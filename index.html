<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>📼 平成レトロカメラ v2</title>
<style>
body{margin:0;padding:1rem;background:#111;color:#eee;font-family:sans-serif;text-align:center;}
h2{margin-bottom:0.5rem;}
#stage{position:relative;width:min(90vw,480px);aspect-ratio:4/3;margin:auto;background:#000;border:2px solid #333;overflow:hidden;}
canvas{width:100%;height:100%;image-rendering:pixelated;image-rendering:crisp-edges;}
#hud{position:absolute;inset:0;pointer-events:none;font-family:monospace;}
.rec{position:absolute;top:10px;left:10px;display:flex;align-items:center;gap:6px;}
.dot{width:10px;height:10px;border-radius:50%;background:red;box-shadow:0 0 6px #f00;}
.date{position:absolute;bottom:10px;right:10px;color:#ffa64d;text-shadow:0 1px 2px #000;}
button,select,input{margin:5px;padding:8px;border:none;border-radius:8px;background:#1d1d1d;color:#eee;font-weight:600;}
#download{display:none;margin-top:10px;}
label{font-size:0.9em;}
</style>
</head>
<body>
<h2>📼 平成カメラ</h2>

<div id="stage">
  <canvas id="canvas" width="640" height="480"></canvas>
  <div id="hud">
    <div class="rec"><div class="dot" id="dot"></div><span>REC</span></div>
    <div class="date" id="date"></div>
  </div>
</div>

<div>
<select id="mode">
  <option value="dslr">📷 一眼風</option>
  <option value="compact">📸 コンデジ風</option>
  <option value="8mm">📼 8ミリ風</option>
</select>
<label>テープノイズ:<input type="range" id="tape" min="0" max="100" value="10"></label>
<label>🎙音声<input type="checkbox" id="mic" checked></label><br>
<button id="photoBtn">📸 写真</button>
<button id="recStart">🎥 録画</button>
<button id="recStop" disabled>⏹ 停止</button>
<a id="download" download="heisei_v2.webm">🎬 ダウンロード</a>
</div>

<video id="video" autoplay playsinline muted style="display:none;"></video>

<script>
(async()=>{
const video=document.getElementById("video");
const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d",{willReadFrequently:true});
const low=document.createElement("canvas");low.width=320;low.height=240;
const lctx=low.getContext("2d",{willReadFrequently:true});
let recorder,blobs=[];let mode="dslr";let stream=null;

// カメラ起動（音声設定切替にも使う）
async function startCamera(){
  if(stream){stream.getTracks().forEach(t=>t.stop());}
  const withAudio=document.getElementById("mic").checked;
  try{
    stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"},audio:withAudio});
    video.srcObject=stream;await video.play();
  }catch(e){alert("カメラ起動失敗："+e);}
}
await startCamera();
document.getElementById("mic").onchange=startCamera;
document.getElementById("mode").onchange=e=>mode=e.target.value;

function updateDate(){
  const n=new Date();
  document.getElementById("date").textContent=`${String(n.getFullYear()).slice(-2)}.${String(n.getMonth()+1).padStart(2,'0')}.${String(n.getDate()).padStart(2,'0')} ${String(n.getHours()).padStart(2,'0')}:${String(n.getMinutes()).padStart(2,'0')}`;
}

function process(img){
  const d=img.data,w=img.width,h=img.height;
  for(let i=0;i<d.length;i+=4){
    let r=d[i],g=d[i+1],b=d[i+2];
    const avg=(r+g+b)/3;

    if(mode==="8mm"){
      // 🎞️ 軽めの粒ノイズ
      const n=(Math.random()-.5)*35;
      r=r*0.93+avg*0.07+n;
      g=g*0.89+avg*0.11+n*0.7;
      b=b*0.86+avg*0.14+n*1.0;

      // 📺 柔らかい走査線（3行おき）
      if(((i/(4*w))|0)%3===0){r*=0.9;g*=0.9;b*=0.9;}

    }else if(mode==="compact"){
      const n=(Math.random()-.5)*15;
      r=r*1.1+n; g=g*1.05+n; b=b*1.05+n;
    }else{
      r=r*1.05; g=g*1.05; b=b*1.05;
    }
    d[i]=r; d[i+1]=g; d[i+2]=b;
  }
  return img;
}

// ---- render() の中の描画部を書き換え ----
function render(){
  if(video.readyState>=2){
    const vw=video.videoWidth,vh=video.videoHeight;
    const ar=vw/vh,tar=4/3;let sx=0,sy=0,sw=vw,sh=vh;
    if(ar>tar){sw=vh*tar;sx=(vw-sw)/2;}else{sh=vw/tar;sy=(vh-sh)/2;}
    lctx.drawImage(video,sx,sy,sw,sh,0,0,low.width,low.height);
    let img=lctx.getImageData(0,0,low.width,low.height);
    lctx.putImageData(process(img),0,0);

    // ---- 🌞 露出ゆらぎ ----
    let exp=1.0;
    if(mode==="8mm"){
      exp = 0.95 + Math.random()*0.1; // ±5%
      ctx.filter = `brightness(${exp}) contrast(1.05)`;
    } else {
      ctx.filter = "none";
    }

    // ---- 📼 光漏れ演出 ----
    if(mode==="8mm" && Math.random()<0.02){ // 約2%の確率で
      const grad=ctx.createRadialGradient(
        Math.random()*canvas.width, Math.random()*canvas.height,
        50, canvas.width/2, canvas.height/2, canvas.width
      );
      grad.addColorStop(0,"rgba(255,200,150,0.4)");
      grad.addColorStop(1,"rgba(255,150,100,0)");
      ctx.fillStyle=grad;
      ctx.fillRect(0,0,canvas.width,canvas.height);
    }

    // ---- 通常描画（手ブレあり） ----
    const shake=(mode==="8mm")?(Math.random()*2-1):0;
    ctx.imageSmoothingEnabled=false;
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.drawImage(low,shake,shake,canvas.width,canvas.height);

    // ---- テープノイズ ----
    const tapeVal=+document.getElementById("tape").value;
    if(Math.random()<tapeVal/1000){
      const y=Math.random()*canvas.height|0;
      const h=5+Math.random()*15;
      ctx.drawImage(canvas,0,y,canvas.width,h,Math.random()*10-5,y,canvas.width,h);
    }
  }

  updateDate();
  document.getElementById("dot").style.opacity=(Date.now()/500%2>1)?1:0.3;
  requestAnimationFrame(render);
}

render();

// 📸 写真
document.getElementById("photoBtn").onclick=()=>{
  canvas.toBlob(blob=>{
    const a=document.createElement("a");
    a.href=URL.createObjectURL(blob);
    a.download=`heisei_${mode}_${Date.now()}.jpg`;
    a.click();
    URL.revokeObjectURL(a.href);
  },"image/jpeg",mode==="compact"?0.6:0.9);
};

// 🎥 録画
document.getElementById("recStart").onclick=()=>{
  blobs=[];
  const fps=(mode==="8mm"?12:24);
  const canvasStream=canvas.captureStream(fps);
  // 音声ミックス
  const audioTrack=stream.getAudioTracks()[0];
  if(audioTrack)canvasStream.addTrack(audioTrack);
  recorder=new MediaRecorder(canvasStream,{mimeType:"video/webm"});
  recorder.ondataavailable=e=>{if(e.data.size>0)blobs.push(e.data);};
  recorder.onstop=()=>{
    const blob=new Blob(blobs,{type:"video/webm"});
    const url=URL.createObjectURL(blob);
    const a=document.getElementById("download");
    a.href=url;a.style.display="inline";
    a.textContent=`🎬 ダウンロード (${(blob.size/1024/1024).toFixed(1)}MB)`;
  };
  recorder.start(100);
  recStart.disabled=true;recStop.disabled=false;
};
document.getElementById("recStop").onclick=()=>{
  recorder.stop();recStart.disabled=false;recStop.disabled=true;
};
})();
</script>
</body>
</html>

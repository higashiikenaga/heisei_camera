<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>ğŸ“¼ å¹³æˆã‚«ãƒ¡ãƒ© Web</title>
<style>
  :root { color-scheme: dark; }
  body{margin:0; background:#0c0c0c; color:#eee; font:16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans JP", sans-serif; display:flex; flex-direction:column; align-items:center; gap:10px; padding:16px;}
  header{font-weight:700; letter-spacing:.02em; opacity:.9; display:flex; align-items:center; gap:.5rem;}
  main{width:min(92vw,520px); display:flex; flex-direction:column; align-items:center; gap:10px;}
  #stage{position:relative; width:100%; aspect-ratio:4/3; background:#111; border:2px solid #222; border-radius:10px; overflow:hidden; box-shadow:0 8px 24px #0008;}
  /* è¡¨ç¤ºç”¨ã‚­ãƒ£ãƒ³ãƒã‚¹ã¯æ‹¡å¤§ã—ã¦ã‚‚ãƒ‰ãƒƒãƒˆè’ã‚Œã‚’ç¶­æŒ */
  #display{width:100%; height:100%; image-rendering: pixelated; image-rendering: crisp-edges; display:block;}
  #hud{position:absolute; inset:0; pointer-events:none; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Noto Sans Mono", monospace;}
  #hud .rec{position:absolute; left:10px; top:10px; display:flex; align-items:center; gap:8px; font-weight:700; text-shadow:0 1px 2px #000a;}
  #hud .dot{width:12px; height:12px; border-radius:50%; background:#e22; box-shadow:0 0 8px #f00c;}
  #hud .date{position:absolute; right:10px; bottom:10px; color:#ffa64d; text-shadow:0 1px 2px #000c; font-weight:700;}
  #controls{display:grid; grid-template-columns:1fr auto; gap:10px; width:100%;}
  #controls .row{grid-column:1 / -1; display:grid; grid-template-columns:1fr 1fr; gap:10px;}
  button, select, input[type=range]{appearance:none; border:none; border-radius:10px; padding:12px; background:#1b1b1b; color:#eee; box-shadow: inset 0 0 0 1px #2a2a2a; font-weight:700;}
  button.primary{background:#ff3b30; box-shadow: inset 0 0 0 1px #ff5f57; }
  button:active{transform:translateY(1px);}
  small{opacity:.7}
</style>
</head>
<body>
  <header>ğŸ“¼ å¹³æˆã‚«ãƒ¡ãƒ© <small>ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ»å†™çœŸä¿å­˜ï¼‰</small></header>
  <main>
    <div id="stage">
      <canvas id="display" width="640" height="480"></canvas>
      <div id="hud">
        <div class="rec"><span class="dot" id="recdot"></span><span>REC</span></div>
        <div class="date" id="dateText"></div>
      </div>
    </div>

    <div id="controls">
      <div class="row">
        <button id="shutter" class="primary">ğŸ“¸ æ’®å½±ã—ã¦ä¿å­˜</button>
        <button id="swap">ğŸ” ã‚«ãƒ¡ãƒ©åˆ‡æ›¿</button>
      </div>
      <div class="row">
        <label>åŠ£åŒ–ãƒ¬ãƒ™ãƒ«
          <input id="level" type="range" min="0" max="100" value="65">
        </label>
        <label>è§£åƒåº¦ï¼ˆå†…éƒ¨ï¼‰
          <select id="res">
            <option value="320x240">QVGA 320Ã—240</option>
            <option value="400x300">400Ã—300</option>
            <option value="640x480">VGA 640Ã—480</option>
          </select>
        </label>
      </div>
      <div class="row">
        <label>å½©åº¦â†“/ã‚¬ãƒ³ãƒâ†‘
          <input id="sat" type="range" min="0" max="100" value="50">
        </label>
        <label>ãƒã‚¤ã‚ºé‡
          <input id="noise" type="range" min="0" max="100" value="30">
        </label>
      </div>
    </div>

    <small>ãƒ’ãƒ³ãƒˆï¼šHTTPSã§é–‹ãã¨ã‚«ãƒ¡ãƒ©ãŒä½¿ãˆã¾ã™ï¼ˆGitHub Pages ãªã©ï¼‰ã€‚iPhoneã¯ã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€ã§ã»ã¼ã‚¢ãƒ—ãƒªåŒ–ã€‚</small>
  </main>

  <!-- éè¡¨ç¤ºã®video & ã‚ªãƒ•ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãƒãƒƒãƒ•ã‚¡ -->
  <video id="video" autoplay playsinline muted style="position:absolute; left:-9999px;"></video>

<script>
(async () => {
  // --- DOM ---
  const video   = document.getElementById('video');
  const canvas  = document.getElementById('display');
  const ctx     = canvas.getContext('2d', { willReadFrequently: true });
  const recdot  = document.getElementById('recdot');
  const dateTxt = document.getElementById('dateText');

  const shutter = document.getElementById('shutter');
  const swapBtn = document.getElementById('swap');
  const level   = document.getElementById('level');
  const resSel  = document.getElementById('res');
  const satR    = document.getElementById('sat');
  const noiseR  = document.getElementById('noise');

  // å†…éƒ¨ä½è§£åƒåº¦ã‚­ãƒ£ãƒ³ãƒã‚¹ï¼ˆã“ã“ã§è’ã‚‰ã™â†’è¡¨ç¤ºç”¨ã«ãƒ‰ãƒƒãƒˆæ‹¡å¤§ï¼‰
  let lowW = 320, lowH = 240;
  const low = document.createElement('canvas');
  low.width = lowW; low.height = lowH;
  const lctx = low.getContext('2d', { willReadFrequently: true });

  // ãƒ‡ãƒã‚¤ã‚¹é¸æŠï¼ˆèƒŒé¢ã‚«ãƒ¡ãƒ©å„ªå…ˆï¼‰
  let currentFacing = 'environment';
  let currentStream = null;

  async function startCamera() {
    if (currentStream) {
      currentStream.getTracks().forEach(t => t.stop());
      currentStream = null;
    }
    const constraints = {
      audio: false,
      video: {
        facingMode: { ideal: currentFacing },
        width: { ideal: 1280 }, height: { ideal: 720 }
      }
    };
    try {
      const stream = await navigator.mediaDevices.getUserMedia(constraints);
      currentStream = stream;
      video.srcObject = stream;
      await video.play();
    } catch (e) {
      alert('ã‚«ãƒ¡ãƒ©å–å¾—ã«å¤±æ•—: ' + e);
    }
  }

  swapBtn.addEventListener('click', () => {
    currentFacing = (currentFacing === 'environment') ? 'user' : 'environment';
    startCamera();
  });

  // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ›´æ–°
  function parseRes(v) {
    const [w,h] = v.split('x').map(n=>parseInt(n,10));
    return {w,h};
  }
  function updateLowRes() {
    const {w,h} = parseRes(resSel.value);
    lowW = w; lowH = h;
    low.width = lowW; low.height = lowH;
  }
  resSel.addEventListener('change', updateLowRes);

  // ã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼šãƒ”ã‚¯ã‚»ãƒ«å‡¦ç†ï¼ˆé«˜é€Ÿã‚å®Ÿè£…ï¼‰
  function heiseiProcess(imageData) {
    const d = imageData.data;
    const L = d.length;
    // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼å€¤
    const lvl   = +level.value / 100; // å…¨ä½“ã®åŠ£åŒ–ã‚¹ã‚±ãƒ¼ãƒ«
    const satV  = +satR.value / 100;  // å½©åº¦0..1
    const noise = +noiseR.value / 100;

    // ã‚¬ãƒ³ãƒï¼ˆå°‘ã—ä¸Šã’ã‚‹ã¨ç™½é£›ã³ãƒ»é»’æ½°ã‚Œã£ã½ãï¼‰
    const gamma = 1.0 + 0.6 * lvl;
    const invG = 1.0 / gamma;

    // èµ°æŸ»ç·šå¼·åº¦
    const scanAmt = 0.08 + 0.12 * lvl;

    // ç°¡æ˜“ã‚¯ãƒ­ãƒãƒ–ãƒªãƒ¼ãƒ‰ï¼ˆG/Bã‚’1pxå·¦ã«ï¼‰
    // å‚ç…§ã®ãŸã‚ã«1è¡Œãšã¤å‡¦ç†
    for (let y = 0; y < imageData.height; y++) {
      const row = y * imageData.width * 4;
      for (let x = 0; x < imageData.width; x++) {
        const i  = row + x*4;

        // å…ƒè‰²
        let r=d[i], g=d[i+1], b=d[i+2];

        // å½©åº¦ä½ä¸‹ï¼ˆã‚°ãƒ¬ã‚¤å¹³å‡ã«å¯„ã›ã‚‹ï¼‰
        const avg = (r+g+b)/3;
        r = avg*(1-satV) + r*satV;
        g = avg*(1-satV) + g*satV;
        b = avg*(1-satV) + b*satV;

        // ã‚¬ãƒ³ãƒè£œæ­£ï¼ˆè¿‘ä¼¼ï¼špowï¼‰
        r = Math.pow(r/255, invG)*255;
        g = Math.pow(g/255, invG)*255;
        b = Math.pow(b/255, invG)*255;

        // ãƒã‚¤ã‚ºï¼ˆè¼åº¦ + è‰²å°‘ã—ï¼‰
        const n = (Math.random()-0.5) * 60 * noise; // -30..+30 (noise=0.5ã§Â±15)
        r = r + n;
        g = g + n * 0.9;
        b = b + n * 1.1;

        d[i]=r; d[i+1]=g; d[i+2]=b;
      }
      // èµ°æŸ»ç·šï¼ˆå¶æ•°ãƒ©ã‚¤ãƒ³æš—ãï¼‰
      if ((y & 1) === 0) {
        for (let x = 0; x < imageData.width; x++) {
          const k = row + x*4;
          d[k]   *= (1.0 - scanAmt);
          d[k+1] *= (1.0 - scanAmt);
          d[k+2] *= (1.0 - scanAmt);
        }
      }
      // ã‚¯ãƒ­ãƒãƒ–ãƒªãƒ¼ãƒ‰ï¼ˆG/Bã‚’å·¦1pxã‹ã‚‰æ‹å€Ÿï¼‰
      for (let x = imageData.width-1; x >= 1; x--) {
        const i  = row + x*4;
        const il = row + (x-1)*4;
        d[i+1] = d[il+1]; // G
        d[i+2] = d[il+2]; // B
      }
    }

    // ä¸‹ç«¯ãƒ˜ãƒƒãƒ‰åˆ‡æ›¿ãƒã‚¤ã‚ºå¸¯
    const band = Math.max(2, (imageData.height*0.04)|0);
    for (let y = imageData.height - band; y < imageData.height; y++) {
      const f = (y - (imageData.height - band)) / band; // 0..1
      const boost = (0.35 + 0.35 * Math.random()) * (1.0 - f);
      const row = y * imageData.width * 4;
      for (let x = 0; x < imageData.width; x++) {
        const i = row + x*4;
        d[i]   = Math.min(255, d[i]   + 255*boost);
        d[i+1] = Math.min(255, d[i+1] + 255*boost);
        d[i+2] = Math.min(255, d[i+2] + 255*boost);
      }
    }
    return imageData;
  }

  // HUD æ—¥ä»˜
  function updateDate() {
    const now = new Date();
    const y = String(now.getFullYear()).slice(-2);
    const M = String(now.getMonth()+1).padStart(2,'0');
    const D = String(now.getDate()).padStart(2,'0');
    const h = String(now.getHours()).padStart(2,'0');
    const m = String(now.getMinutes()).padStart(2,'0');
    dateTxt.textContent = `${y}.${M}.${D}  ${h}:${m}`;
  }

  // ãƒ¡ã‚¤ãƒ³æç”»ãƒ«ãƒ¼ãƒ—ï¼švideo â†’ low(ä½è§£åƒ) â†’ pixelå‡¦ç† â†’ display(æ‹¡å¤§)
  function render() {
    if (video.readyState >= 2) {
      // videoã‚’4:3ã§ãƒˆãƒªãƒŸãƒ³ã‚°ã—ã¦lowã¸æœ€è¿‘å‚æç”»
      const vw = video.videoWidth, vh = video.videoHeight;
      if (vw && vh) {
        const targetAR = 4/3;
        let sx=0, sy=0, sw=vw, sh=vh;
        const ar = vw/vh;
        if (ar > targetAR) { // æ¨ªé•·â†’å·¦å³ã‚«ãƒƒãƒˆ
          sw = Math.floor(vh * targetAR);
          sx = Math.floor((vw - sw)/2);
        } else {             // ç¸¦é•·â†’ä¸Šä¸‹ã‚«ãƒƒãƒˆ
          sh = Math.floor(vw / targetAR);
          sy = Math.floor((vh - sh)/2);
        }
        // ãƒ‰ãƒƒãƒˆè’ã‚Œã®ãŸã‚ filter=false ç­‰ä¾¡ â†’ drawImage ã§ç¸®å°
        lctx.imageSmoothingEnabled = false;
        lctx.drawImage(video, sx, sy, sw, sh, 0, 0, lowW, lowH);

        // ãƒ”ã‚¯ã‚»ãƒ«å‡¦ç†
        let img = lctx.getImageData(0,0,lowW,lowH);
        img = heiseiProcess(img);
        lctx.putImageData(img, 0, 0);

        // è¡¨ç¤ºã‚­ãƒ£ãƒ³ãƒã‚¹ã¸ãƒ‰ãƒƒãƒˆç­‰å€æ‹¡å¤§
        ctx.imageSmoothingEnabled = false;
        ctx.clearRect(0,0,canvas.width, canvas.height);
        ctx.drawImage(low, 0, 0, canvas.width, canvas.height);
      }
    }
    updateDate();
    // RECç‚¹æ»…
    recdot.style.opacity = (Math.floor(performance.now()/500)%2) ? '1' : '0.25';
    requestAnimationFrame(render);
  }

  // æ’®å½±â†’JPEGä¿å­˜
  shutter.addEventListener('click', () => {
    // ç¾åœ¨ã®displayã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ãã®ã¾ã¾ä¿å­˜
    canvas.toBlob((blob)=>{
      const a = document.createElement('a');
      const url = URL.createObjectURL(blob);
      a.href = url;
      const ts = new Date().toISOString().replace(/[:.]/g,'-');
      a.download = `heisei_${ts}.jpg`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 1000);
    }, 'image/jpeg', 0.75); // ã¡ã‚‡ã„è’ã„jpegåœ§ç¸®
  });

  // åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
  updateLowRes();
  await startCamera();
  render();

  // ç”»é¢å›è»¢ã‚„ãƒªã‚µã‚¤ã‚ºæ™‚ã€è¡¨ç¤ºã‚­ãƒ£ãƒ³ãƒã‚¹ã¯å›ºå®šãƒ”ã‚¯ã‚»ãƒ«ã®ã¾ã¾CSSã§ä¼¸ç¸®ï¼ˆãƒ‰ãƒƒãƒˆä¿æŒï¼‰
  // å¿…è¦ãªã‚‰ã“ã“ã§ canvas.width/height ã‚’å¤‰ãˆã‚‹ã¨ã‚¹ã‚¯ã‚·ãƒ§è§£åƒåº¦ã‚‚å¤‰ãˆã‚‰ã‚Œã¾ã™ã€‚
})();
</script>
</body>
</html>
